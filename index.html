<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Fireworks AR - Feria (fix video)</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar.js"></script>

  <style>
    /* Fullscreen layout */
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      background: black;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* A-Frame scene must cover whole viewport */
    a-scene, #arScene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      z-index: 1;
      background: transparent;
    }

    /* Force the camera video added by AR.js to cover the full viewport.
       We target common class/id names and <video> as a fallback. */
    .arjs-video, video#arjs-video, video[playsinline], video {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;   /* crop to fill, avoids letterbox/pillarbox */
      transform: none !important;
      z-index: 0 !important;
    }

    /* UI overlays on top */
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    #startBtn, #stopBtn {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      cursor: pointer;
    }
    #startBtn { background: linear-gradient(180deg,#28a745,#1f7a31); color: white; }
    #stopBtn  { background: linear-gradient(180deg,#ff6666,#c83232); color: white; display:none; }

    #status {
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index: 9999;
      background: rgba(0,0,0,0.55);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      max-width: 46%;
    }

    /* small help text */
    #hint { color: #fff; font-size: 13px; margin-left: 6px; }
  </style>
</head>
<body>

  <div id="controls">
    <button id="startBtn">üé¨ Start experience</button>
    <button id="stopBtn">‚èπ Stop AR</button>
    <div id="hint">Imprime el marcador HIRO y mantenlo visible</div>
  </div>

  <div id="status">Estado: esperando inicio</div>

  <!-- Escena AR (oculta hasta iniciar) -->
  <a-scene id="arScene" embedded style="display:none"
           arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono;">
    <a-marker preset="hiro" id="hiroMarker">
      <a-entity id="fx-root" position="0 0.25 0" scale="1 1 1"></a-entity>
      <a-plane position="0 0 0" rotation="-90 0 0" width="2" height="2" visible="false"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

<script>
  // L√≥gica similar a la versi√≥n auto-show; foco aqu√≠: forzar fullscreen video y test
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const statusEl = document.getElementById('status');
  const arScene  = document.getElementById('arScene');
  const fxRootSelector = '#fx-root';
  let autoInterval = null;
  let markerVisible = false;

  async function ensureCameraPrompt() {
    statusEl.innerText = 'Estado: solicitando permiso de c√°mara...';
    try {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('getUserMedia no disponible en este navegador.');
      }
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      stream.getTracks().forEach(t => t.stop());
      statusEl.innerText = 'Estado: permiso concedido';
      return true;
    } catch (err) {
      console.error(err);
      statusEl.innerText = 'Estado: permiso denegado o c√°mara no disponible';
      return false;
    }
  }

  function showScene() {
    // Mostrar escena
    arScene.style.display = 'block';
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    statusEl.innerText = 'Estado: apunta al marcador HIRO';
    // Forzar reflow para que AR.js inyecte el video correctamente
    setTimeout(() => {
      // Ajuste adicional: si AR.js cre√≥ un video, forzamos estilos (por si no aplic√≥)
      const v1 = document.querySelector('.arjs-video');
      const v2 = document.querySelector('video#arjs-video');
      const v3 = document.querySelector('video[playsinline]');
      const video = v1 || v2 || v3;
      if (video) {
        video.style.objectFit = 'cover';
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.top = '0';
        video.style.left = '0';
      }
    }, 600);
    setupMarkerListeners(); // attach events
  }

  startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    const ok = await ensureCameraPrompt();
    if (!ok) { startBtn.disabled = false; return; }
    showScene();
  });

  stopBtn.addEventListener('click', () => {
    // limpiar auto shows y ocultar escena
    clearInterval(autoInterval);
    autoInterval = null;
    arScene.style.display = 'none';
    stopBtn.style.display = 'none';
    startBtn.style.display = 'inline-block';
    statusEl.innerText = 'Estado: detenido';
  });

  // PARTICLES / SHOW (vistoso, largo)
  function spawnExplosion(colorHex, amount = 80, originY = 1.3, duration = 5000) {
    const root = document.querySelector(fxRootSelector);
    if (!root) return;
    const group = document.createElement('a-entity');
    for (let i = 0; i < amount; i++) {
      const s = document.createElement('a-sphere');
      const r = 0.04 + Math.random() * 0.06;
      s.setAttribute('radius', r.toFixed(3));
      s.setAttribute('color', colorHex);
      s.setAttribute('position', `0 ${originY} 0`);
      s.setAttribute('material', 'opacity:1; transparent:true;');

      const ang = Math.random() * Math.PI * 2;
      const rad = 0.8 + Math.random() * 1.8;
      const dx = Math.cos(ang) * rad;
      const dy = 0.6 + Math.random() * 2.0;
      const dz = Math.sin(ang) * rad;
      const dur = 1000 + Math.random() * 2000;

      s.setAttribute('animation__move', `
        property: position;
        to: ${dx.toFixed(3)} ${dy.toFixed(3)} ${dz.toFixed(3)};
        dur: ${Math.floor(dur)};
        easing: easeOutCubic;
        loop: false;
      `);
      s.setAttribute('animation__fade', `
        property: material.opacity;
        to: 0;
        dur: ${Math.floor(dur + 400)};
        delay: ${Math.floor(dur*0.05)};
      `);
      group.appendChild(s);
    }
    root.appendChild(group);
    setTimeout(()=> { if (root.contains(group)) root.removeChild(group); }, duration + 1500);
  }

  function launchShowSequence() {
    spawnExplosion('#ff2d55', 90, 1.4, 7000);
    setTimeout(()=> spawnExplosion('#ffd60a', 80, 1.3, 7000), 500);
    setTimeout(()=> spawnExplosion('#32d74b', 80, 1.5, 7000), 1100);
    setTimeout(()=> spawnExplosion('#5ac8fa', 70, 1.6, 7000), 1700);
    setTimeout(()=> spawnExplosion('#bf5af2', 70, 1.4, 7000), 2400);
    setTimeout(()=> spawnExplosion('#ffffff', 130, 1.7, 8000), 3200); // gran final
  }

  function startAutoShows() {
    if (autoInterval) return;
    launchShowSequence();
    autoInterval = setInterval(launchShowSequence, 9000); // cada 9s
    statusEl.innerText = 'Estado: marcador visible ‚Äî show autom√°tico activo';
  }
  function stopAutoShows() {
    if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
  }

  function setupMarkerListeners() {
    const marker = document.getElementById('hiroMarker');
    if (!marker) { statusEl.innerText = 'Error: no se encontr√≥ marker en la escena.'; return; }

    marker.addEventListener('markerFound', () => {
      markerVisible = true;
      statusEl.innerText = 'Estado: marcador detectado ‚Äî preparando show';
      setTimeout(()=> { if (markerVisible) startAutoShows(); }, 600);
    });
    marker.addEventListener('markerLost', () => {
      markerVisible = false;
      statusEl.innerText = 'Estado: marcador perdido ‚Äî show en pausa';
      stopAutoShows();
      // conservar part√≠culas visibles por unos segundos
    });
  }

  // Debug: log en consola para verificar video element y tama√±o
  window.addEventListener('load', () => {
    console.log('Carga completa. Abre la p√°gina en Chrome/Safari y pulsa Start experience.');
  });
  window.addEventListener('error', (e) => {
    console.error('Error global:', e);
    statusEl.innerText = 'Error: revis√° consola o prob√° otro navegador. Usa Chrome o Safari.';
  });
</script>
</body>
</html>

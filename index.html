<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Fireworks AR - FIXED Zoom & Big Show</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar.js"></script>

  <style>
    html,body { margin:0; height:100%; background:#000; font-family: Arial, sans-serif; }
    /* Scene full-viewport */
    a-scene { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; }

    /* Force default video behavior to avoid browser zoom/crop:
       we set object-fit: contain so the video fits inside viewport without zooming.
       Then we center the scene and use A-Frame elements overlayed on top. */
    video, .arjs-video, video#arjs-video, video[playsinline] {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;   /* <-- key change (avoid zooming) */
      transform: none !important;
      z-index: 0 !important;
      background: black;
    }

    /* UI overlays */
    #ui {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      display:flex;
      gap:8px;
      align-items:center;
    }
    #startBtn, #stopBtn {
      padding:10px 14px;
      border-radius:8px;
      border:none;
      font-size:14px;
      cursor:pointer;
    }
    #startBtn { background:#1FAE2F; color:white; }
    #stopBtn  { background:#E03F3F; color:white; display:none; }
    #status {
      position: fixed;
      left: 12px;
      bottom: 12px;
      z-index:9999;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      max-width: 60%;
    }
    #debug {
      position: fixed;
      right: 12px;
      top: 12px;
      z-index:9999;
      color:#fff;
      font-size:12px;
      background: rgba(0,0,0,0.35);
      padding:6px 8px;
      border-radius:6px;
    }
  </style>
</head>
<body>

  <div id="ui">
    <button id="startBtn">▶ Start experience</button>
    <button id="stopBtn">■ Stop AR</button>
    <div id="hint" style="color:#fff;font-size:13px;margin-left:8px">Imprime el marcador HIRO y mantenlo visible</div>
  </div>

  <div id="status">Estado: esperando inicio</div>
  <div id="debug">debug: -</div>

  <!-- Scene (hidden until start) -->
  <a-scene id="scene" embedded style="display:none"
           arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono;">
    <a-marker preset="hiro" id="hiroMarker">
      <!-- origin un poco mas arriba para que los fuegos sean claramente visibles -->
      <a-entity id="fx-root" position="0 0.45 0" scale="1.6 1.6 1.6"></a-entity>
      <a-plane position="0 0 0" rotation="-90 0 0" width="2" height="2" visible="false"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

<script>
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const statusEl = document.getElementById('status');
  const debugEl  = document.getElementById('debug');
  const sceneEl  = document.getElementById('scene');
  let autoInterval = null;
  let markerVisible = false;

  // ENSURE camera prompt (forces permission; AR.js will re-open stream)
  async function requestCamera() {
    statusEl.innerText = 'Estado: solicitando permiso de cámara...';
    debugEl.innerText = 'debug: requesting getUserMedia';
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      stream.getTracks().forEach(t => t.stop());
      debugEl.innerText = 'debug: permiso concedido';
      return true;
    } catch (err) {
      console.error(err);
      debugEl.innerText = 'debug: permiso DENEGADO or getUserMedia error';
      statusEl.innerText = 'Estado: permiso denegado o cámara no disponible';
      return false;
    }
  }

  // Force video styling again after AR.js injects it
  function enforceVideoStyle() {
    // try a few selectors
    const selectors = ['.arjs-video', 'video#arjs-video', 'video[playsinline]', 'video'];
    for (const sel of selectors) {
      const v = document.querySelector(sel);
      if (v) {
        v.style.objectFit = 'contain';
        v.style.width = '100%';
        v.style.height = '100%';
        v.style.top = '0';
        v.style.left = '0';
        v.style.transform = 'none';
      }
    }
    debugEl.innerText = 'debug: video style enforced';
  }

  async function startExperience() {
    startBtn.disabled = true;
    const ok = await requestCamera();
    if (!ok) { startBtn.disabled = false; return; }
    // show scene and wait a moment for AR.js to create the video element
    sceneEl.style.display = 'block';
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    statusEl.innerText = 'Estado: cámara activa — apunta al HIRO';
    // after small delay, enforce style (ensures proper object-fit)
    setTimeout(enforceVideoStyle, 400);
    setTimeout(enforceVideoStyle, 1000);
    setTimeout(enforceVideoStyle, 2000);
    // prepare marker listeners
    setupMarkerListeners();
  }

  function stopExperience() {
    stopAuto();
    // hide scene and reset UI
    sceneEl.style.display = 'none';
    stopBtn.style.display = 'none';
    startBtn.style.display = 'inline-block';
    statusEl.innerText = 'Estado: detenido';
    debugEl.innerText = 'debug: stopped';
  }

  startBtn.addEventListener('click', startExperience);
  stopBtn.addEventListener('click', stopExperience);

  // --- visual fireworks (vistoso y duradero) ---
  function spawnExplosion(color, count = 100, originY = 1.6, lifeMs = 8000) {
    const root = document.querySelector('#fx-root');
    if (!root) return;
    const group = document.createElement('a-entity');

    for (let i = 0; i < count; i++) {
      const s = document.createElement('a-sphere');
      const r = 0.035 + Math.random() * 0.07;
      s.setAttribute('radius', r.toFixed(3));
      s.setAttribute('color', color);
      s.setAttribute('position', `0 ${originY} 0`);
      s.setAttribute('material', 'opacity:1; transparent:true;');

      const ang = Math.random() * Math.PI * 2;
      const rad = 0.8 + Math.random() * 2.0;
      const dx = Math.cos(ang) * rad;
      const dy = 0.8 + Math.random() * 2.2;
      const dz = Math.sin(ang) * rad;
      const dur = 1200 + Math.random() * 2200;

      s.setAttribute('animation__move', `
        property: position;
        to: ${dx.toFixed(3)} ${dy.toFixed(3)} ${dz.toFixed(3)};
        dur: ${Math.floor(dur)};
        easing: easeOutCubic;
        loop: false;
      `);
      s.setAttribute('animation__fade', `
        property: material.opacity;
        to: 0;
        dur: ${Math.floor(dur + 800)};
        delay: ${Math.floor(dur*0.08)};
      `);

      group.appendChild(s);
    }

    root.appendChild(group);
    // cleanup after lifeMs + buffer
    setTimeout(()=> { if (root.contains(group)) root.removeChild(group); }, lifeMs + 1200);
  }

  function launchSequence() {
    spawnExplosion('#ff2d55', 120, 1.5, 8000);
    setTimeout(()=> spawnExplosion('#ffd60a', 100, 1.3, 8000), 600);
    setTimeout(()=> spawnExplosion('#32d74b', 100, 1.6, 8000), 1200);
    setTimeout(()=> spawnExplosion('#5ac8fa', 90, 1.7, 8000), 2000);
    setTimeout(()=> spawnExplosion('#bf5af2', 90, 1.5, 8000), 2800);
    setTimeout(()=> spawnExplosion('#ffffff', 180, 1.8, 9000), 3800); // final
  }

  // auto while marker visible
  function startAuto() {
    if (autoInterval) return;
    launchSequence();
    autoInterval = setInterval(launchSequence, 10000); // cada 10s (ajustable)
    statusEl.innerText = 'Estado: show automático activo';
  }
  function stopAuto() {
    if (!autoInterval) return;
    clearInterval(autoInterval);
    autoInterval = null;
    statusEl.innerText = 'Estado: show detenido';
  }

  // --- marker listeners ---
  function setupMarkerListeners() {
    const marker = document.getElementById('hiroMarker');
    if (!marker) {
      debugEl.innerText = 'debug: marker no encontrado';
      statusEl.innerText = 'Error interno: marker no en DOM';
      return;
    }
    marker.addEventListener('markerFound', () => {
      console.log('markerFound');
      debugEl.innerText = 'debug: markerFound';
      markerVisible = true;
      // ensure video style when marker found
      setTimeout(enforceVideoStyle, 200);
      // start automatic shows (after stability)
      setTimeout(()=> { if (markerVisible) startAuto(); }, 700);
    });
    marker.addEventListener('markerLost', () => {
      console.log('markerLost');
      debugEl.innerText = 'debug: markerLost';
      markerVisible = false;
      stopAuto();
      // keep particles for a bit so show remains impressive
    });
  }

  // small guidance log
  console.log('Fixed AR page loaded. Use Chrome (Android) or Safari (iOS). Keep marker ~25-40cm from camera.');
</script>
</body>
</html>

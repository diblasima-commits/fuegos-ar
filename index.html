<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Fireworks AR - Feria (Auto)</title>

  <!-- A-Frame y AR.js (CDN estable) -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar.js"></script>

  <style>
    html,body { height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:#000; color:#fff; }
    #controls {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 9999;
      display:flex;
      gap:8px;
      align-items:center;
    }
    #startBtn, #stopBtn {
      padding:10px 14px;
      border-radius:8px;
      border: none;
      font-size:15px;
      cursor:pointer;
    }
    #startBtn { background: linear-gradient(180deg,#28a745,#1f7a31); color:white; }
    #stopBtn  { background: linear-gradient(180deg,#ff6666,#c83232); color:white; display:none; }
    #status {
      position: fixed;
      left: 12px;
      bottom: 12px;
      background: rgba(0,0,0,0.6);
      padding:8px 10px;
      border-radius:8px;
      font-size:13px;
      z-index:9999;
      max-width: 46%;
    }
    a-scene { width:100%; height:100%; display:block; }
  </style>
</head>
<body>

  <div id="controls">
    <button id="startBtn">üé¨ Start experience</button>
    <button id="stopBtn">‚èπ Stop AR</button>
    <div id="hint" style="font-size:13px; margin-left:6px;">Imprime el marcador HIRO y apunt√° la c√°mara.</div>
  </div>

  <div id="status">Estado: esperando inicio</div>

  <!-- Escena AR (oculta hasta que se inicie) -->
  <a-scene id="arScene" embedded style="display:none"
           arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; matrixCodeType: 3;">
    <a-marker preset="hiro" id="hiroMarker">
      <!-- Punto de origen: elevamos un poco para que se vean los fuegos sobre el marcador -->
      <a-entity id="fx-root" position="0 0.2 0" scale="1 1 1"></a-entity>
      <!-- Piso invisible para referencia -->
      <a-plane position="0 0 0" rotation="-90 0 0" width="2" height="2" visible="false"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

<script>
  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const statusEl = document.getElementById('status');
  const arScene  = document.getElementById('arScene');
  const fxRootSelector = '#fx-root';
  let markerVisible = false;
  let autoInterval = null;

  // Forzar prompt de c√°mara y mostrar escena
  async function startExperience() {
    startBtn.disabled = true;
    statusEl.innerText = 'Estado: solicitando permiso de c√°mara...';
    try {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('getUserMedia no disponible en este navegador.');
      }
      // Pedimos la c√°mara para forzar prompt; AR.js abrir√° su propia c√°mara despu√©s
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(t => t.stop());
    } catch (err) {
      statusEl.innerText = 'Estado: permiso denegado o c√°mara no disponible.';
      startBtn.disabled = false;
      console.error(err);
      return;
    }

    // Mostrar la escena AR
    arScene.style.display = 'block';
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';
    statusEl.innerText = 'Estado: apunta al marcador HIRO (mantener en vista)';

    // configuramos listeners de marker
    setupMarkerListeners();
  }

  // Parar AR (ocultar escena y limpiar)
  function stopExperience() {
    // limpiar intervalos y part√≠culas
    clearAuto();
    clearAllParticles();
    arScene.style.display = 'none';
    startBtn.style.display = 'inline-block';
    stopBtn.style.display = 'none';
    statusEl.innerText = 'Estado: detenido';
  }

  startBtn.addEventListener('click', startExperience);
  stopBtn.addEventListener('click', stopExperience);

  // --- PARTICLE / FIREWORKS LOGIC ---
  function spawnExplosion(colorHex, strength = 60, originY = 1.2) {
    // strength -> cantidad de part√≠culas
    const root = document.querySelector(fxRootSelector);
    if (!root) return;
    const group = document.createElement('a-entity');

    for (let i = 0; i < strength; i++) {
      const s = document.createElement('a-sphere');
      const r = 0.03 + Math.random() * 0.06;
      s.setAttribute('radius', r.toFixed(3));
      s.setAttribute('color', colorHex);
      s.setAttribute('position', `0 ${originY} 0`);
      s.setAttribute('material', 'opacity:1; transparent:true;');

      // trayectoria aleatoria
      const ang = Math.random() * Math.PI * 2;
      const rad = 0.6 + Math.random() * 1.6; // alcance
      const dx = Math.cos(ang) * rad * (0.6 + Math.random()*0.8);
      const dy = 0.6 + Math.random() * 1.8;
      const dz = Math.sin(ang) * rad * (0.6 + Math.random()*0.8);
      const dur = 1200 + Math.random() * 1600;

      s.setAttribute('animation__move', `
        property: position;
        to: ${dx.toFixed(3)} ${dy.toFixed(3)} ${dz.toFixed(3)};
        dur: ${Math.floor(dur)};
        easing: easeOutCubic;
        loop: false;
      `);
      s.setAttribute('animation__fade', `
        property: material.opacity;
        to: 0;
        dur: ${Math.floor(dur)};
        delay: ${Math.floor(dur * 0.12)};
      `);
      group.appendChild(s);
    }

    root.appendChild(group);
    // limpiamos despu√©s de 6s (bastante visible para feria)
    setTimeout(()=> { if (root.contains(group)) root.removeChild(group); }, 6500);
  }

  // Lanza una secuencia vistosa (varios bursts)
  function launchShowSequence() {
    // bursts con distintos colores y tiempos
    spawnExplosion('#ff2d55', 80, 1.3);
    setTimeout(()=> spawnExplosion('#ffd60a', 70, 1.2), 400);
    setTimeout(()=> spawnExplosion('#32d74b', 70, 1.4), 800);
    setTimeout(()=> spawnExplosion('#5ac8fa', 60, 1.5), 1400);
    setTimeout(()=> spawnExplosion('#bf5af2', 60, 1.3), 2000);
    // un gran final
    setTimeout(()=> spawnExplosion('#ffffff', 120, 1.6), 2600);
  }

  function clearAllParticles() {
    const root = document.querySelector(fxRootSelector);
    if (!root) return;
    root.innerHTML = '';
  }

  // Auto: mientras el marker est√© visible, lanzar cada X segundos
  function startAuto() {
    if (autoInterval) return;
    // lanza inmediatamente y despu√©s cada 5 segundos
    launchShowSequence();
    autoInterval = setInterval(launchShowSequence, 5000);
    statusEl.innerText = 'Estado: marcador visible ‚Äî show en curso';
  }

  function clearAuto() {
    if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
  }

  // --- MARKER EVENT HANDLERS ---
  function setupMarkerListeners() {
    const marker = document.getElementById('hiroMarker');
    if (!marker) {
      statusEl.innerText = 'Estado: no se encontr√≥ el marcador en la escena (error interno).';
      return;
    }

    marker.addEventListener('markerFound', () => {
      markerVisible = true;
      statusEl.innerText = 'Estado: marcador detectado ‚Äî iniciando shows autom√°ticos';
      // peque√±o delay para asegurar tracking estable
      setTimeout(()=> { if (markerVisible) startAuto(); }, 600);
    });

    marker.addEventListener('markerLost', () => {
      markerVisible = false;
      statusEl.innerText = 'Estado: marcador perdido ‚Äî show pausado';
      clearAuto();
      // no borramos inmediatamente las part√≠culas para que el efecto se vea
    });
  }

  // Extra: detectar errores globales y sugerir pasos
  window.addEventListener('error', (e) => {
    console.error('Error global:', e);
    statusEl.innerText = 'Error: revis√° consola o prob√° otro navegador. Us√° Chrome/Safari (no dentro de apps).';
  });

  // Sugerencias r√°pidas en console para debug
  console.log('Fireworks AR: c√≥digo cargado. Recomendado: abrir en Chrome (Android) o Safari (iOS).');

</script>
</body>
</html>

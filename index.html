<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fireworks AR - Feria</title>

  <!-- A-Frame y AR.js -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    html,body { height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; background:#000; }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.45);
      color: white;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 9999;
      max-width: 48%;
    }
    #hint {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.92);
      color: #111;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 9999;
    }
    /* fallback overlay button (some mobiles lo mostrar√°n) */
    #overlay-launch {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg,#ff4d6d,#c4003b);
      color: #fff;
      border: none;
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      z-index: 9999;
      display: none; /* lo mostraremos si es compatible */
    }
    #overlay-launch:active { transform: translateX(-50%) scale(0.98); }
    a-scene { width:100%; height:100%; display:block; }
  </style>
</head>
<body>

  <div id="info">
    üéÜ Fireworks AR ‚Äî Feria escolar<br>
    1) Abr√≠ este link en el celular<br>
    2) Permit√≠ el acceso a la c√°mara<br>
    3) Apunt√° al marcador <em>Hiro</em><br>
    4) Toca el bot√≥n virtual (sobre el marcador) o el bot√≥n en pantalla
  </div>

  <div id="hint">Marker: <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank" style="color:#ffd;">Hiro (open)</a></div>

  <button id="overlay-launch">üöÄ Launch!</button>

  <!-- Escena A-Frame con AR.js (marker-based) -->
  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-marker preset="hiro">

      <!-- Nodo ra√≠z -->
      <a-entity id="fx-root" position="0 0 0"></a-entity>

      <!-- Bot√≥n virtual AR: un plano con texto que siempre queda sobre el marcador -->
      <a-entity id="virtual-button" position="0 0.4 0" rotation="-30 0 0" visible="true">
        <a-plane id="btn-plane" width="0.6" height="0.25" color="#ff3366" material="shader:flat; opacity:0.95" class="clickable"></a-plane>
        <a-text value="üöÄ LAUNCH" align="center" position="0 0 0.01" color="#fff" width="2.5"></a-text>

        <!-- borde visual -->
        <a-ring radius-inner="0.35" radius-outer="0.36" position="0 -0.06 0.001" rotation="-90 0 0" color="#ffffff" material="opacity:0.25"></a-ring>
      </a-entity>

      <!-- Un peque√±o "piso" invisible para referenciar efectos -->
      <a-plane position="0 0 0" rotation="-90 0 0" width="2" height="2" visible="false"></a-plane>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

<script>
  const root = document.getElementById('fx-root');
  const overlayBtn = document.getElementById('overlay-launch');

  // Mostrar overlay si el navegador lo permite (fallback)
  function showOverlayIfPossible() {
    // algunos navegadores m√≥viles ocultan position:fixed en modo AR, pero vale la pena probar
    overlayBtn.style.display = 'block';
  }
  showOverlayIfPossible();

  // ---- Part√≠culas y l√≥gica de lanzamiento (mismo comportamiento que antes) ----
  function spawnParticles(colorHex, count = 24, originY = 1.0) {
    const particles = document.createElement('a-entity');
    for (let i = 0; i < count; i++) {
      const s = document.createElement('a-sphere');
      const r = 0.03 + Math.random() * 0.05;
      s.setAttribute('radius', r.toFixed(3));
      s.setAttribute('color', colorHex);
      s.setAttribute('position', `0 ${originY} 0`);

      const dx = (Math.random() - 0.5) * 2.2;
      const dy = 0.6 + Math.random() * 1.4;
      const dz = (Math.random() - 0.5) * 2.2;
      const dur = 700 + Math.random() * 700;

      s.setAttribute('animation__move', `
        property: position;
        to: ${dx.toFixed(3)} ${dy.toFixed(3)} ${dz.toFixed(3)};
        dur: ${dur.toFixed(0)};
        easing: easeOutCubic;
        loop: false;
      `);

      s.setAttribute('material', 'opacity:1; transparent:true;');
      s.setAttribute('animation__fade', `
        property: material.opacity;
        to: 0;
        dur: ${dur.toFixed(0)};
        easing: linear;
        delay: ${Math.floor(dur*0.1)};
      `);

      particles.appendChild(s);
    }

    root.appendChild(particles);
    setTimeout(() => { if (root.contains(particles)) root.removeChild(particles); }, 2400);
  }

  function launchRocket(colorHex) {
    const rocket = document.createElement('a-sphere');
    rocket.setAttribute('radius', 0.05);
    rocket.setAttribute('color', colorHex);
    rocket.setAttribute('position', '0 0 0');

    rocket.setAttribute('animation__rise', `
      property: position;
      to: 0 1.6 0;
      dur: 700;
      easing: easeOutQuad;
      loop: false;
    `);

    root.appendChild(rocket);

    setTimeout(() => {
      spawnParticles(colorHex, 30, 1.6);
      if (root.contains(rocket)) root.removeChild(rocket);
    }, 720);
  }

  function launchShow() {
    // desactivar temporalmente para evitar spam
    overlayBtn.disabled = true;
    overlayBtn.style.opacity = 0.6;
    launchRocket('#ff2233');
    setTimeout(() => launchRocket('#00d1ff'), 250);
    setTimeout(() => launchRocket('#33ff66'), 450);
    setTimeout(() => { overlayBtn.disabled = false; overlayBtn.style.opacity = 1; }, 2200);
  }

  // ---- eventos para overlay button (fallback) ----
  overlayBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    launchShow();
  });

  // ---- Eventos para el bot√≥n virtual dentro de la escena AR ----
  // Usamos raycaster de A-Frame para detectar clicks/taps en el plano 'btn-plane'
  AFRAME.registerComponent('tap-listener', {
    init: function () {
      const el = this.el;
      // cuando recibimos el evento 'click' desde el sistema, ejecutamos
      el.addEventListener('click', (evt) => {
        launchShow();
      });

      // Tambi√©n atender event touches en dispositivos que no emitan el click
      el.addEventListener('touchstart', (evt) => {
        launchShow();
      });
    }
  });

  // Asociar el componente al plano cuando la escena est√© lista
  document.querySelector('a-scene').addEventListener('loaded', () => {
    const plane = document.querySelector('#btn-plane');
    if (plane) {
      plane.setAttribute('class', 'interactive');
      plane.setAttribute('tap-listener', '');
      // Habilitar raycaster en la c√°mara para detectar el toque
      const cam = document.querySelector('[camera]');
      if (cam && !cam.getAttribute('raycaster')) {
        cam.setAttribute('raycaster', 'objects: .interactive; far: 10');
      }
    }
  });

  // ---- Consejo: en m√≥viles, si no aparece, tocar la pantalla una vez para activar UI ----
  document.body.addEventListener('click', () => {
    // noop, solo para generar la primera interacci√≥n en algunos navegadores
  }, { once: true });

</script>

</body>
</html>
